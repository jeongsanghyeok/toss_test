<!-- Breadcrumb -->
<div class="bg-gray-50 py-4">
  <div class="container mx-auto px-4 lg:px-6">
    <nav class="flex items-center space-x-2 text-sm">
      <%= link_to "홈", root_path, class: "text-gray-500 hover:text-purple-600 transition-colors duration-200" %>
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <%= link_to "상품", products_path, class: "text-gray-500 hover:text-purple-600 transition-colors duration-200" %>
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <%= link_to @product.category, products_path(category: @product.category), class: "text-gray-500 hover:text-purple-600 transition-colors duration-200" %>
      
      <!-- 서브카테고리 추가 (상품명에 따라 동적으로 결정) -->
      <% subcategory = case @product.category
                       when '전자기기'
                         if @product.name.include?('iPhone') || @product.name.include?('Galaxy') || @product.name.include?('스마트폰')
                           '휴대폰'
                         elsif @product.name.include?('MacBook') || @product.name.include?('iPad') || @product.name.include?('PC') || @product.name.include?('태블릿')
                           'PC/태블릿'
                         elsif @product.name.include?('워치') || @product.name.include?('Watch')
                           '웨어러블'
                         elsif @product.name.include?('이어폰') || @product.name.include?('헤드폰')
                           '오디오'
                         else
                           '기타 전자기기'
                         end
                       when '의류'
                         if @product.name.include?('니트') || @product.name.include?('티셔츠') || @product.name.include?('셔츠')
                           '상의'
                         elsif @product.name.include?('재킷') || @product.name.include?('코트') || @product.name.include?('아우터')
                           '아우터'
                         elsif @product.name.include?('스카프') || @product.name.include?('가방') || @product.name.include?('액세서리')
                           '잡화'
                         else
                           '의류'
                         end
                       when '도서'
                         if @product.name.include?('프로그래밍') || @product.name.include?('개발') || @product.name.include?('웹')
                           '전문서적'
                         elsif @product.name.include?('소설')
                           '소설'
                         else
                           '도서'
                         end
                       when '생활용품'
                         if @product.name.include?('디퓨저') || @product.name.include?('향')
                           '인테리어'
                         elsif @product.name.include?('텀블러') || @product.name.include?('컵')
                           '주방용품'
                         elsif @product.name.include?('요가') || @product.name.include?('운동')
                           '스포츠/헬스'
                         else
                           '생활용품'
                         end
                       else
                         nil
                       end %>
      
      <% if subcategory && subcategory != @product.category %>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <%= link_to subcategory, products_path(category: @product.category, subcategory: subcategory), class: "text-gray-500 hover:text-purple-600 transition-colors duration-200" %>
      <% end %>
      
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <span class="text-gray-900 font-medium"><%= @product.name %></span>
    </nav>
  </div>
</div>

<!-- Product Detail -->
<div class="container mx-auto px-4 lg:px-6 py-12">
  
  <!-- Back Button -->
  <div class="mb-8">
    <%= link_to products_path, class: "inline-flex items-center text-gray-600 hover:text-purple-600 transition-colors duration-200 group" do %>
      <svg class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      상품 목록으로 돌아가기
    <% end %>
  </div>

  <!-- Product Content -->
  <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
    <div class="lg:flex">
      
      <!-- Product Images -->
      <div class="lg:w-1/2">
        <div class="relative group">
          <% if @product.image_url.present? %>
            <%= image_tag @product.image_url, class: "w-full h-96 lg:h-full object-cover group-hover:scale-105 transition-transform duration-500", alt: @product.name %>
          <% else %>
            <div class="w-full h-96 lg:h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-gray-500">이미지 준비중</span>
              </div>
            </div>
          <% end %>
          
          <!-- Image Overlay -->
          <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </div>
      </div>

      <!-- Product Info -->
      <div class="lg:w-1/2 p-8 lg:p-12">
        
        <!-- Category Badge -->
        <div class="mb-4">
          <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold gradient-bg text-white">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
            <%= @product.category %>
          </span>
        </div>

        <!-- Product Title -->
        <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-6 leading-tight">
          <%= @product.name %>
        </h1>

        <!-- Product Description -->
        <div class="mb-8">
          <p class="text-gray-600 text-lg leading-relaxed">
            <%= @product.description %>
          </p>
        </div>

        <!-- Product Features -->
        <div class="mb-8 p-6 bg-gray-50 rounded-2xl">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">제품 특징</h3>
          <ul class="space-y-3">
            <li class="flex items-center text-gray-700">
              <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              최고급 소재 및 품질 보증
            </li>
            <li class="flex items-center text-gray-700">
              <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              전국 무료배송 (24시간 내 발송)
            </li>
            <li class="flex items-center text-gray-700">
              <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              30일 무료 교환 및 반품 보장
            </li>
            <li class="flex items-center text-gray-700">
              <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              24/7 고객 지원 서비스
            </li>
          </ul>
        </div>

        <!-- Price -->
        <div class="mb-8">
          <div class="flex items-baseline space-x-2">
            <span class="text-4xl lg:text-5xl font-bold text-gray-900">
              ₩<%= number_with_delimiter(@product.price) %>
            </span>
            <span class="text-lg text-gray-500">
              (부가세 포함)
            </span>
          </div>
          <p class="text-sm text-gray-500 mt-2">
            * 무이자 할부 가능 (카드사별 상이)
          </p>
        </div>

        <!-- Add to Cart Form -->
        <%= form_with url: cart_items_path, method: :post, local: true, class: "mb-8", id: "add-to-cart-form" do |form| %>
          <%= form.hidden_field :product_id, value: @product.id %>
          
          <div class="flex items-center space-x-4 mb-6">
            <label class="text-sm font-semibold text-gray-700">수량:</label>
            <div class="flex items-center border-2 border-gray-200 rounded-xl overflow-hidden">
              <button type="button" onclick="decrementQuantity()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                </svg>
              </button>
              <%= form.number_field :quantity, value: 1, min: 1, max: 99, 
                  class: "w-16 py-2 text-center font-semibold text-gray-900 bg-white focus:outline-none", 
                  id: "quantity-input" %>
              <button type="button" onclick="incrementQuantity()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="space-y-4">
            <%= form.submit "장바구니에 추가", 
                class: "w-full gradient-bg text-white font-bold py-4 px-6 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 text-lg",
                id: "add-to-cart-btn" %>
            
            <button type="button" onclick="buyNow()" 
                    class="w-full bg-gray-900 text-white font-bold py-4 px-6 rounded-xl hover:bg-gray-800 transition-colors duration-200 text-lg">
              바로 구매하기
            </button>
          </div>
        <% end %>

        <!-- Additional Actions -->
        <div class="flex items-center justify-center space-x-6 text-sm">
          <%= link_to cart_path, class: "flex items-center text-gray-600 hover:text-purple-600 transition-colors duration-200" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13M5.4 7H5m2 6v4a2 2 0 002 2h6a2 2 0 002-2v-4"/>
            </svg>
            장바구니 보기
          <% end %>
          
          <button class="flex items-center text-gray-600 hover:text-red-500 transition-colors duration-200">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            찜하기
          </button>
          
          <button class="flex items-center text-gray-600 hover:text-blue-500 transition-colors duration-200">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
            </svg>
            공유하기
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Info Sections -->
  <div class="mt-16" id="product-sections">
    
    <!-- Navigation Tabs -->
    <div class="bg-white shadow-2xl overflow-hidden mb-8 sticky z-40" style="top: 80px; border-radius: 0 0 24px 24px; backdrop-filter: blur(10px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);"">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8 px-8 overflow-x-auto">
          <button onclick="scrollToSection('info')" class="nav-tab border-transparent text-purple-600 border-b-2 border-purple-600 py-4 px-1 text-sm font-medium whitespace-nowrap" id="info-nav">
            상품 정보
          </button>
          <button onclick="scrollToSection('shipping')" class="nav-tab border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium whitespace-nowrap" id="shipping-nav">
            배송/교환/반품
          </button>
          <button onclick="scrollToSection('reviews')" class="nav-tab border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium whitespace-nowrap" id="reviews-nav">
            리뷰 (<span id="review-count">0</span>)
          </button>
          <button onclick="scrollToSection('inquiry')" class="nav-tab border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium whitespace-nowrap" id="inquiry-nav">
            문의 (<span id="inquiry-count">0</span>)
          </button>
        </nav>
      </div>
    </div>

    <!-- Sections Container -->
    <div class="space-y-8">
      <!-- 상품 정보 섹션 -->
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden" id="info-section">
      <div class="p-8">
        <div class="prose max-w-none">
          <h3 class="text-xl font-semibold text-gray-900 mb-6">상품 상세 정보</h3>
          
          <% if @product.detailed_description.present? %>
            <div class="text-gray-700 leading-relaxed mb-8 whitespace-pre-line">
              <%= simple_format(@product.detailed_description) %>
            </div>
          <% else %>
            <p class="text-gray-600 leading-relaxed mb-6">
              <%= @product.description %>
            </p>
          <% end %>
          
          <!-- 상세 이미지들 -->
          <% if @product.detail_image_url_array.any? %>
            <div class="mb-8">
              <h4 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                상세 이미지
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <% @product.detail_image_url_array.each_with_index do |image_url, index| %>
                  <div class="relative group cursor-pointer" onclick="openImageModal('<%= image_url %>', '<%= @product.name %> - 이미지 <%= index + 1 %>')">
                    <div class="rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 bg-white p-2">
                      <%= image_tag image_url, class: "w-full h-48 object-cover rounded-xl group-hover:scale-105 transition-transform duration-300", alt: "#{@product.name} - 상세 이미지 #{index + 1}", onerror: "this.parentElement.style.display='none';" %>
                      <div class="absolute inset-0 bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-300 rounded-2xl flex items-center justify-center">
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white bg-opacity-90 rounded-full p-2">
                          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                          </svg>
                        </div>
                      </div>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-2">이미지 <%= index + 1 %></p>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <div class="bg-gray-50 rounded-xl p-6">
            <h4 class="font-semibold text-gray-900 mb-4">구매 안내</h4>
            <ul class="space-y-2 text-sm text-gray-600">
              <li>• 상품 주문 완료 후 1~2일 내에 배송이 시작됩니다.</li>
              <li>• 배송 지역에 따라 배송 기간이 추가로 소요될 수 있습니다.</li>
              <li>• 상품의 색상은 모니터 설정에 따라 실제와 다를 수 있습니다.</li>
              <li>• 교환 및 반품은 상품 수령 후 7일 이내에 가능합니다.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 배송/교환/반품 섹션 -->
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden" id="shipping-section">
      <div class="p-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">배송/교환/반품 정보</h3>
        
        <div class="space-y-8">
          <div>
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4-8-4m16 0v10l-8 4-8-4V7"/>
              </svg>
              배송 정보
            </h4>
            <div class="bg-blue-50 rounded-xl p-6">
              <ul class="space-y-2 text-sm text-gray-700">
                <li>• <strong>배송비:</strong> 전국 무료배송 (3만원 이상 구매 시)</li>
                <li>• <strong>배송기간:</strong> 주문 완료 후 1~3일 (영업일 기준)</li>
                <li>• <strong>배송업체:</strong> CJ대한통운, 로젠택배</li>
                <li>• <strong>배송지역:</strong> 전국 (제주/도서산간 지역 포함)</li>
                <li>• <strong>특별배송:</strong> 당일배송, 새벽배송 서비스 제공 (수도권 한정)</li>
              </ul>
            </div>
          </div>
          
          <div>
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              교환/반품 정책
            </h4>
            <div class="bg-green-50 rounded-xl p-6">
              <ul class="space-y-2 text-sm text-gray-700">
                <li>• <strong>교환/반품 기간:</strong> 상품 수령 후 7일 이내</li>
                <li>• <strong>교환/반품 비용:</strong> 무료 (단, 고객 변심 시 왕복 배송비 고객 부담)</li>
                <li>• <strong>교환/반품 조건:</strong> 미사용 상품, 태그 및 포장재 보존</li>
                <li>• <strong>불가능한 경우:</strong> 사용 흔적, 세탁, 수선한 상품</li>
                <li>• <strong>환불 방법:</strong> 원결제수단으로 환불 (카드 취소, 계좌이체)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 리뷰 섹션 -->
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden" id="reviews-section">
      <div class="p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">상품 리뷰</h3>
          <button onclick="openReviewModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
            리뷰 작성하기
          </button>
        </div>
        
        <div id="reviews-list" class="space-y-6">
          <div class="text-center py-12 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m10 0v10a2 2 0 01-2 2H9a2 2 0 01-2-2V8m10 0H7"/>
            </svg>
            <p class="text-lg mb-2">아직 리뷰가 없습니다</p>
            <p class="text-sm">첫 번째 리뷰를 작성해보세요!</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 문의 섹션 -->
    <div class="bg-white rounded-3xl shadow-xl overflow-hidden" id="inquiry-section">
      <div class="p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">상품 문의</h3>
          <button onclick="openInquiryModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
            문의하기
          </button>
        </div>
        
        <div id="inquiry-list" class="space-y-6">
          <div class="text-center py-12 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-lg mb-2">문의 내역이 없습니다</p>
            <p class="text-sm">궁금한 점이 있으시면 언제든 문의해주세요!</p>
          </div>
        </div>
      </div>
    </div>
    
    </div> <!-- End sections container -->
  </div>
</div>

<script>
  function incrementQuantity() {
    const input = document.getElementById('quantity-input');
    const currentValue = parseInt(input.value);
    if (currentValue < 99) {
      input.value = currentValue + 1;
    }
  }

  function decrementQuantity() {
    const input = document.getElementById('quantity-input');
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
      input.value = currentValue - 1;
    }
  }

  function buyNow() {
    const form = document.getElementById('add-to-cart-form');
    const formData = new FormData(form);
    
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      }
    }).then(response => {
      if (response.ok) {
        window.location.href = '/payments/checkout';
      }
    });
  }

  // Add to cart with AJAX and modal
  document.getElementById('add-to-cart-btn').addEventListener('click', function(e) {
    e.preventDefault();
    const btn = e.target;
    const originalText = btn.innerHTML;
    const form = document.getElementById('add-to-cart-form');
    const formData = new FormData(form);
    
    btn.innerHTML = '추가중...';
    btn.disabled = true;
    
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        btn.innerHTML = '✓ 추가완료!';
        // 헤더의 장바구니 카운터 업데이트
        updateCartCount(data.cart_count);
        setTimeout(() => {
          openCartModal();
        }, 500);
      } else {
        btn.innerHTML = '추가 실패';
        alert(data.message);
      }
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    })
    .catch(error => {
      console.error('Error:', error);
      btn.innerHTML = '추가 실패';
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    });
  });

  // 섹션으로 스크롤하는 함수
  function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId + '-section');
    if (section) {
      // 모든 탭 버튼에서 active 클래스 제거
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('text-purple-600', 'border-purple-600', 'border-b-2');
        btn.classList.add('text-gray-500');
      });
      
      // 선택된 탭 버튼 활성화
      const activeButton = document.getElementById(sectionId + '-nav');
      if (activeButton) {
        activeButton.classList.remove('text-gray-500');
        activeButton.classList.add('text-purple-600', 'border-purple-600', 'border-b-2');
      }
      
      // 상단 메뉴와 탭 네비게이션 높이를 고려해서 스크롤
      const headerHeight = 80; // 상단 메뉴 높이
      const navHeight = 70; // 탭 네비게이션 높이
      const totalOffset = headerHeight + navHeight + 20; // 여유분 20px 추가
      const targetPosition = section.getBoundingClientRect().top + window.pageYOffset - totalOffset;
      
      window.scrollTo({
        top: targetPosition,
        behavior: 'smooth'
      });
    }
  }

  // 스크롤 위치에 따라 탭 활성화 상태 업데이트
  function updateActiveTab() {
    const sections = ['info', 'shipping', 'reviews', 'inquiry'];
    let currentSection = 'info';
    const headerHeight = 80; // 상단 메뉴 높이
    const navHeight = 70; // 탭 네비게이션 높이
    const threshold = headerHeight + navHeight + 50; // 여유분 50px
    
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId + '-section');
      if (section) {
        const rect = section.getBoundingClientRect();
        if (rect.top <= threshold) {
          currentSection = sectionId;
        }
      }
    });
    
    // 모든 탭 버튼에서 active 클래스 제거
    document.querySelectorAll('.nav-tab').forEach(btn => {
      btn.classList.remove('text-purple-600', 'border-purple-600', 'border-b-2');
      btn.classList.add('text-gray-500');
    });
    
    // 현재 섹션 탭 활성화
    const activeButton = document.getElementById(currentSection + '-nav');
    if (activeButton) {
      activeButton.classList.remove('text-gray-500');
      activeButton.classList.add('text-purple-600', 'border-purple-600', 'border-b-2');
    }
  }

  // 리뷰 작성 모달 열기
  function openReviewModal() {
    document.getElementById('reviewModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  // 리뷰 작성 모달 닫기
  function closeReviewModal() {
    document.getElementById('reviewModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // 문의 작성 모달 열기
  function openInquiryModal() {
    document.getElementById('inquiryModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  // 문의 작성 모달 닫기
  function closeInquiryModal() {
    document.getElementById('inquiryModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // 별점 클릭 이벤트
  function setRating(rating) {
    const stars = document.querySelectorAll('.star');
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add('text-yellow-400');
        star.classList.remove('text-gray-300');
      } else {
        star.classList.add('text-gray-300');
        star.classList.remove('text-yellow-400');
      }
    });
    document.getElementById('ratingValue').value = rating;
  }

  // 리뷰 제출
  function submitReview() {
    const rating = document.getElementById('ratingValue').value;
    const reviewText = document.getElementById('reviewText').value.trim();
    
    if (!rating) {
      alert('별점을 선택해주세요.');
      return;
    }
    
    if (!reviewText) {
      alert('리뷰 내용을 작성해주세요.');
      return;
    }
    
    // TODO: 실제 서버로 리뷰 데이터 전송
    alert('리뷰가 등록되었습니다. 감사합니다!');
    closeReviewModal();
    
    // 폼 리셋
    document.getElementById('ratingValue').value = '';
    document.getElementById('reviewText').value = '';
    setRating(0);
  }

  // 문의 제출
  function submitInquiry() {
    const inquiryType = document.getElementById('inquiryType').value;
    const inquiryText = document.getElementById('inquiryText').value.trim();
    
    if (!inquiryType) {
      alert('문의 유형을 선택해주세요.');
      return;
    }
    
    if (!inquiryText) {
      alert('문의 내용을 작성해주세요.');
      return;
    }
    
    // TODO: 실제 서버로 문의 데이터 전송
    alert('문의가 등록되었습니다. 빠른 시일 내에 답변드리겠습니다.');
    closeInquiryModal();
    
    // 폼 리셋
    document.getElementById('inquiryType').value = '';
    document.getElementById('inquiryText').value = '';
  }
  
  // 이미지 모달 열기
  function openImageModal(imageUrl, title) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('imageModalImg');
    const titleEl = document.getElementById('imageModalTitle');
    const spinner = document.getElementById('imageLoadingSpinner');
    const errorState = document.getElementById('imageErrorState');
    
    console.log('Opening image modal with URL:', imageUrl);
    
    // 모달 열기 전 상태 초기화
    img.classList.add('hidden');
    errorState.classList.add('hidden');
    spinner.classList.remove('hidden');
    titleEl.textContent = title;
    
    // 모달 열기
    modal.style.display = 'flex';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // 직접 이미지 로드
    img.onload = function() {
      console.log('Image loaded successfully');
      spinner.classList.add('hidden');
      img.classList.remove('hidden');
    };
    
    img.onerror = function() {
      console.log('Image load failed');
      spinner.classList.add('hidden');
      errorState.classList.remove('hidden');
    };
    
    img.src = imageUrl;
  }

  // 이미지 모달 닫기
  function closeImageModal() {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('imageModalImg');
    const spinner = document.getElementById('imageLoadingSpinner');
    const errorState = document.getElementById('imageErrorState');
    
    modal.style.display = 'none';
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    
    // 상태 초기화
    img.classList.add('hidden');
    img.src = '';
    img.onload = null;
    img.onerror = null;
    spinner.classList.add('hidden');
    errorState.classList.add('hidden');
  }

  // 장바구니 추가 후 모달 열기
  function openCartModal() {
    document.getElementById('cartModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  // 장바구니 모달 닫기
  function closeCartModal() {
    document.getElementById('cartModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // 계속 쇼핑하기
  function continueShopping() {
    closeCartModal();
  }

  // 장바구니로 이동
  function goToCart() {
    window.location.href = '/cart';
  }

  // 장바구니 카운터 업데이트
  function updateCartCount(count) {
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
      cartCountElement.textContent = count;
      // 애니메이션 효과 추가
      cartCountElement.classList.add('animate-pulse');
      setTimeout(() => {
        cartCountElement.classList.remove('animate-pulse');
      }, 1000);
    }
  }

  // 페이지 로드 시 이벤트 설정
  document.addEventListener('DOMContentLoaded', function() {
    // 모달 배경 클릭 시 닫기
    document.getElementById('imageModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeImageModal();
      }
    });
    
    // 스크롤 이벤트 리스너 추가
    let scrollTimeout;
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateActiveTab, 100);
    });
    
    // 초기 탭 상태 설정
    updateActiveTab();
    
    // 현재 상품을 최근 본 상품에 추가
    if (window.addProductToRecent) {
      const productData = {
        id: <%= @product.id %>,
        name: '<%= j @product.name %>',
        category: '<%= j @product.category %>',
        price: <%= @product.price %>,
        image_url: '<%= j @product.image_url %>'
      };
      window.addProductToRecent(productData);
    }
  });
</script>

<!-- 리뷰 작성 모달 -->
<div id="reviewModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">리뷰 작성</h3>
        <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <!-- 별점 선택 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">별점 *</label>
          <div class="flex items-center space-x-1">
            <% (1..5).each do |i| %>
              <button type="button" onclick="setRating(<%= i %>)" class="star text-gray-300 hover:text-yellow-400 transition-colors duration-200">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              </button>
            <% end %>
          </div>
          <input type="hidden" id="ratingValue" value="">
        </div>
        
        <!-- 리뷰 내용 -->
        <div>
          <label for="reviewText" class="block text-sm font-medium text-gray-700 mb-2">리뷰 내용 *</label>
          <textarea id="reviewText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="상품에 대한 솔직한 후기를 작성해주세요."></textarea>
        </div>
        
        <!-- 버튼 -->
        <div class="flex space-x-3 pt-4">
          <button onclick="closeReviewModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors duration-200">
            취소
          </button>
          <button onclick="submitReview()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
            리뷰 등록
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 이미지 확대 모달 -->
<div id="imageModal" class="fixed inset-0 hidden flex items-center justify-center p-4" style="z-index: 9999; background: rgba(0, 0, 0, 0.8);">
  <div class="relative max-w-4xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
    <!-- 닫기 버튼 -->
    <button onclick="closeImageModal()" class="absolute top-4 right-4 z-10 text-gray-600 hover:text-gray-800 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 transition-all duration-200">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    
    <!-- 이미지 영역 -->
    <div class="relative bg-gray-50 flex items-center justify-center" style="min-height: 400px; max-height: 80vh;">
      <!-- 로딩 스피너 -->
      <div id="imageLoadingSpinner" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
        <p class="text-gray-600 font-medium">이미지 로딩 중...</p>
      </div>
      
      <!-- 실제 이미지 -->
      <img id="imageModalImg" src="" alt="" class="max-w-full max-h-full object-contain hidden">
      
      <!-- 에러 상태 -->
      <div id="imageErrorState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-50">
        <svg class="w-16 h-16 mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <p class="text-center font-medium">이미지를 불러올 수 없습니다</p>
      </div>
    </div>
    
    <!-- 제목 -->
    <div class="p-4 bg-white border-t border-gray-200">
      <h3 id="imageModalTitle" class="text-center text-lg font-semibold text-gray-900"></h3>
    </div>
  </div>
</div>

<!-- 문의 작성 모달 -->
<div id="inquiryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">상품 문의</h3>
        <button onclick="closeInquiryModal()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <!-- 문의 유형 -->
        <div>
          <label for="inquiryType" class="block text-sm font-medium text-gray-700 mb-2">문의 유형 *</label>
          <select id="inquiryType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="">문의 유형을 선택해주세요</option>
            <option value="product">상품 문의</option>
            <option value="delivery">배송 문의</option>
            <option value="exchange">교환/반품 문의</option>
            <option value="size">사이즈 문의</option>
            <option value="etc">기타 문의</option>
          </select>
        </div>
        
        <!-- 문의 내용 -->
        <div>
          <label for="inquiryText" class="block text-sm font-medium text-gray-700 mb-2">문의 내용 *</label>
          <textarea id="inquiryText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="궁금한 점을 자세히 작성해주세요."></textarea>
        </div>
        
        <!-- 안내 메시지 -->
        <div class="bg-blue-50 rounded-lg p-3">
          <p class="text-sm text-blue-700">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            문의 주신 내용은 1~2일 내에 답변 드리겠습니다.
          </p>
        </div>
        
        <!-- 버튼 -->
        <div class="flex space-x-3 pt-4">
          <button onclick="closeInquiryModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors duration-200">
            취소
          </button>
          <button onclick="submitInquiry()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
            문의 등록
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 장바구니 추가 후 선택 모달 -->
<div id="cartModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full">
    <div class="p-8 text-center">
      <!-- 성공 아이콘 -->
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-6">
        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      
      <!-- 메시지 -->
      <h3 class="text-2xl font-bold text-gray-900 mb-2">장바구니에 추가되었습니다!</h3>
      <p class="text-gray-600 mb-8">계속 쇼핑하시겠어요? 아니면 장바구니를 확인하시겠어요?</p>
      
      <!-- 버튼들 -->
      <div class="flex space-x-4">
        <button onclick="continueShopping()" 
                class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-xl transition-colors duration-200">
          계속 쇼핑하기
        </button>
        <button onclick="goToCart()" 
                class="flex-1 gradient-bg text-white font-semibold py-3 px-6 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
          장바구니 보기
        </button>
      </div>
      
      <!-- 닫기 버튼 -->
      <button onclick="closeCartModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>
</div>
