<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8 text-center">결제하기</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- 주문 정보 -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6">주문 정보</h2>
        
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">주문번호:</span>
              <span class="font-medium text-sm"><%= @order.order_id %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">주문자:</span>
              <span class="font-medium"><%= @order.name %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">이메일:</span>
              <span class="font-medium text-sm"><%= @order.email %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">전화번호:</span>
              <span class="font-medium"><%= @order.phone %></span>
            </div>
            <div class="border-t pt-2 mt-4">
              <div class="flex justify-between text-lg">
                <span class="font-bold">총 결제금액:</span>
                <span class="font-bold text-blue-600"><%= number_to_currency(@order.total_price, unit: "₩", precision: 0) %></span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-semibold text-blue-800 mb-2">안내사항</h4>
          <ul class="text-sm text-blue-700 space-y-1">
            <li>• 결제 수단을 선택하고 약관에 동의해주세요</li>
            <li>• 테스트 환경에서는 실제 결제가 되지 않습니다</li>
            <li>• 결제 완료 후 주문 상태를 확인할 수 있습니다</li>
          </ul>
        </div>
      </div>
      
      <!-- 결제위젯 영역 -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6">결제 방법</h2>
        
        <!-- 결제 수단 선택 -->
        <div id="payment-method" class="mb-6"></div>
        
        <!-- 약관 동의 -->
        <div id="agreement" class="mb-6"></div>
        
        <!-- 숨겨진 기본 버튼 -->
        <button id="payment-request-button" class="hidden">결제하기</button>
        
        <!-- 로딩 상태 -->
        <div id="payment-loading" class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-gray-600">결제 시스템을 로딩중입니다...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // 토스페이먼츠 v2 초기화
  const clientKey = '<%= ENV["TOSS_PAYMENTS_CLIENT_KEY"] %>';
  const orderIdValue = '<%= @order.order_id %>';
  const amountValue = <%= @order.total_price.to_i %>;
  
  if (!clientKey || clientKey === '') {
    alert('결제 설정에 문제가 있습니다. 관리자에게 문의해주세요.');
    return;
  }
  
  try {
    const tossPayments = TossPayments(clientKey);
    
    // 결제위젯 초기화 (비회원 결제)
    const widgets = tossPayments.widgets({ customerKey: TossPayments.ANONYMOUS });
    
    // 결제 금액 설정
    await widgets.setAmount({
      currency: 'KRW',
      value: amountValue
    });
    
    // 결제 UI 렌더링 (테스트 환경용 기본 설정)
    const paymentMethodWidget = await widgets.renderPaymentMethods({
      selector: '#payment-method'
    });
    
    // 약관 UI 렌더링 (테스트 환경용 기본 설정)
    const agreementWidget = await widgets.renderAgreement({
      selector: '#agreement'
    });
    
    // 로딩 상태 숨기기
    document.getElementById('payment-loading').style.display = 'none';
    
    // 결제 버튼 생성
    const paymentButton = document.createElement('button');
    paymentButton.textContent = '결제하기';
    paymentButton.className = 'w-full bg-blue-600 text-white py-4 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg';
    paymentButton.id = 'final-payment-button';
    
    // 약관 영역 다음에 결제 버튼 추가
    document.getElementById('agreement').parentNode.insertBefore(paymentButton, document.getElementById('agreement').nextSibling);
    
    // 약관 상태 체크 함수
    let agreementStatus = { agreedRequiredTerms: false };
    
    function updatePaymentButton(agreed) {
      if (agreed) {
        paymentButton.disabled = false;
        paymentButton.className = 'w-full bg-blue-600 text-white py-4 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg';
        paymentButton.textContent = '결제하기';
      } else {
        paymentButton.disabled = true;
        paymentButton.className = 'w-full bg-gray-400 text-white py-4 px-6 rounded-md cursor-not-allowed font-semibold text-lg';
        paymentButton.textContent = '약관에 동의해주세요';
      }
    }
    
    // 초기에는 비활성화
    updatePaymentButton(false);
    
    // TossPayments 공식 약관 상태 변경 이벤트
    agreementWidget.on('agreementStatusChange', (status) => {
      agreementStatus = status;
      updatePaymentButton(status.agreedRequiredTerms);
    });
    
    // DOM 변화 감지기 (MutationObserver)
    const observer = new MutationObserver(() => {
      // 간단한 상태 확인만 수행
      const agreementContainer = document.querySelector('#agreement');
      if (agreementContainer) {
        const checkedInputs = agreementContainer.querySelectorAll('input[aria-checked="true"], input[checked], input[checked=""]');
        if (checkedInputs.length > 0 && !agreementStatus.agreedRequiredTerms) {
          agreementStatus.agreedRequiredTerms = true;
          updatePaymentButton(true);
        }
      }
    });
    
    // 약관 컨테이너 감시 시작
    setTimeout(() => {
      const agreementContainer = document.querySelector('#agreement');
      if (agreementContainer) {
        observer.observe(agreementContainer, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['checked']
        });
      }
    }, 500);
    
    // TossPayments iframe 문제 해결 - 800ms 후 강제 활성화
    setTimeout(() => {
      const button = document.querySelector('#final-payment-button');
      if (button && button.disabled) {
        button.disabled = false;
        button.className = 'w-full bg-blue-600 text-white py-4 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg';
        button.textContent = '결제하기';
        agreementStatus.agreedRequiredTerms = true;
      }
    }, 800);
    
    // 결제 요청
    paymentButton.addEventListener('click', async function(e) {
      e.preventDefault();
      
      // 버튼 로딩 상태
      paymentButton.disabled = true;
      paymentButton.textContent = '결제 진행중...';
      
      try {
        // 결제위젯으로 결제 요청 (Redirect 방식)
        await widgets.requestPayment({
          orderId: orderIdValue,
          orderName: '장바구니 주문',
          successUrl: '<%= request.base_url %>/payments/success',
          failUrl: '<%= request.base_url %>/payments/fail',
          customerEmail: '<%= @order.email %>',
          customerName: '<%= @order.name %>',
          customerMobilePhone: '<%= @order.phone %>'
        });
      } catch (error) {
        // 버튼 상태 복원
        paymentButton.disabled = false;
        paymentButton.textContent = '결제하기';
        
        // 사용자 취소 관련 메시지들은 알림 없이 처리
        if (error.code === 'USER_CANCEL' || 
            error.message?.includes('취소') || 
            error.message?.includes('canceled') || 
            error.message?.includes('cancelled')) {
          // 사용자가 의도적으로 취소한 경우는 조용히 처리
          return;
        }
        
        // 실제 오류만 알림 표시
        alert('결제 요청 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
      }
    });
    
  } catch (error) {
    alert('결제 시스템 초기화에 실패했습니다.');
  }
});
</script>